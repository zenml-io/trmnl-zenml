name: Update TRMNL Display

on:
  # Run every 30 minutes
  schedule:
    - cron: '*/30 * * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      view_mode:
        description: 'View mode'
        required: false
        default: 'recent_runs'
        type: choice
        options:
          - recent_runs
          - pipelines_overview
          - running_only
      dry_run:
        description: 'Dry run (print payload only)'
        required: false
        default: false
        type: boolean

jobs:
  update-trmnl:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync

      - name: Update TRMNL display
        env:
          ZENML_SERVER_URL: ${{ secrets.ZENML_SERVER_URL }}
          ZENML_API_KEY: ${{ secrets.ZENML_API_KEY }}
          ZENML_PROJECT: ${{ secrets.ZENML_PROJECT || 'default' }}
          TRMNL_WEBHOOK_URL: ${{ secrets.TRMNL_WEBHOOK_URL }}
          VIEW_MODE: ${{ github.event.inputs.view_mode || 'recent_runs' }}
          DISPLAY_TIMEZONE: ${{ vars.DISPLAY_TIMEZONE || 'UTC' }}
        run: |
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            uv run python zenml_trmnl.py --dry-run
          else
            uv run python zenml_trmnl.py
          fi
